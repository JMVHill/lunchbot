#!/usr/bin/env python

from slackclient import SlackClient
import signal
import sys
from LunchBot import LunchBot
from DumpBot import DumpBot
from DoodleBot import DoodleBot
from SlackMonitor import SlackMonitor

if len(sys.argv) < 2:
    print >>sys.stderr, "Usage: {} channel[s...]".format(sys.argv[0])
    sys.exit(1)
arg_channels = sys.argv[1:]

# bot constants
BOT_TOKEN = "<redacted>"

# global slack connection
slackconnection = SlackClient(BOT_TOKEN)

# setup channel monitoring
lunchbot = LunchBot(slackconnection, "lunchbot")
#dumpbot = DumpBot(slackconnection, "dumpbot")
doodlebot = DoodleBot(slackconnection, "doodlebot")

slackmonitor = SlackMonitor(slackconnection)
for channel in arg_channels:
    slackmonitor.add_handler_for_channel(lunchbot, channel)
    slackmonitor.add_handler_for_channel(doodlebot, channel)

# catch SIGINT, cleanup before exit
def interrupt_handler(signal, frame):
    global slackmonitor
    slackmonitor.teardown()
    sys.exit(2)
signal.signal(signal.SIGINT, interrupt_handler)

# and begin
print "connected, watching {}...".format(', '.join(map(lambda c: '#{}'.format(c), arg_channels)))
slackmonitor.run()
